<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지인 등록 카드 선택</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            background-color: #f5f5f5;
            position: relative;
        }

        #username {
            margin-top: 20px;
            margin-right: 10px;
            font-weight: bold;
            align-self: flex-end;
        }

        #back {
            position: absolute;
            left: 35px;
            top: 30px;
            width: 148px;
            height: 27px;
        }

        #registered_person {
            position: absolute;
            left: 52px;
            top: 246px;
            width: 398px;
            height: 34px;
        }

        .card-container {
            display: flex;
            align-items: flex-start;
            overflow-x: auto;
            overflow-y: hidden;
            width: calc(100% - 20px);
            padding-top: 315px;
            padding-left: 80px;
            position: relative;
        }

        .card {
            perspective: 1000px;
            margin: 0 10px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }

        .name_card {
            width: 346px;
            height: 487px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .card.flipped .name_card {
            transform: rotateY(180deg);
        }

        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-size: cover;
        }

        .front {
            background: url('/static/image/NameCard.png') no-repeat center center;
        }

        .back {
            transform: rotateY(180deg);
            background: url('/static/image/NameCardBack.png') no-repeat center center;
        }

        .name-text-front {
            color: white;
            font-size: 27px;
            font-weight: bold;
            position: absolute;
            top: 40px; /* 위치를 상단으로 조정 */
            left: 20px; /* 위치를 좌측으로 조정 */
            width: auto;
            text-align: left;
            z-index: 1; /* 카드 요소 위에 위치하도록 설정 */
        }

        .edit-button {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 53px;
            height: 40px;
            cursor: pointer;
            z-index: 10;
        }

        .edit-input {
            width: 80%;
            padding: 5px;
            position: absolute;
            display: none;
            z-index: 15;
        }

        .name-input {
            top: 20%;
        }

        .description-input {
            top: 35%;
        }

        .saved-text {
            position: absolute;
            width: 80%;
            text-align: center;
            color: white;
            font-size: 18px;
            word-wrap: break-word;
            display: none;
            z-index: 10;
        }

        .name-text {
            font-weight: bold;
            font-size: 22px;
            margin-bottom: 10px;
            top: 20%;
        }

        .description-text {
            font-size: 16px;
            top: 35%;
        }

        #info-container {
            position: absolute;
            left: 460px; /* 위치 조정 필요 */
            top: 246px; /* 위치 조정 필요 */
            display: flex;
            align-items: center;
            z-index: 20; /* z-index 추가 */
        }

        #info_icon {
            cursor: pointer;
            width: 32px; /* 크기 조정 필요 */
            height: 32px; /* 크기 조정 필요 */
        }

        #info_text {
            display: none; /* 초기 상태는 숨김 */
            width: 519px;  /* 텍스트 이미지의 너비 조정 */
            height: auto;  /* 자동 높이 조정 */
            margin-left: 15px; /* 아이콘과 텍스트 간의 간격 조정 */
            z-index: 21;   /* 아이콘보다 위에 위치하도록 설정 */
            position: absolute; /* 절대 위치 지정 */
            left: 30px;    /* 위치 조정 */
            bottom: 0px;        /* 위치 조정 */
        }

        #add-person {
            cursor: pointer;
            width: 125px;
            height: 155px;
            margin-left: 20px; /* 원래 위치로 복원 */
            margin-top: 140px; /* 원래 위치로 복원 */
            z-index: 10;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
<div id="username">User Name</div>

<a href="{{ url_for('camselect') }}">
    <img id="back" src="/static/image/Back.png" alt="Back">
</a>

<img id="registered_person" src="/static/image/RegisteredPerson.png" alt="Registered Person">

<div id="info-container">
    <img id="info_icon" src="/static/image/info_icon.png" alt="Info Icon" onclick="toggleInfoText()">
    <img id="info_text" src="/static/image/info_text.png" alt="Info Text">
</div>

<div id="cardContainer" class="card-container">
    <img id="add-person" src="/static/image/add_person.png" alt="Add Person" onclick="addCard()">
</div>

<script>
    // 페이지가 로드될 때 실행되는 함수
    document.addEventListener('DOMContentLoaded', (event) => {
        const currentSessionID = sessionStorage.getItem('sessionID');
        const newSessionID = Date.now().toString();

        // 세션 ID가 없으면 새로운 세션을 시작하고 로컬 스토리지를 초기화
        if (!currentSessionID) {
            sessionStorage.setItem('sessionID', newSessionID);
            localStorage.clear();
        } else {
            sessionStorage.setItem('sessionID', newSessionID);
        }

        // 저장된 카드를 불러옴
        loadCards();
    });

    // 카드를 뒤집는 함수
    function flipCard(card) {
        card.classList.toggle('flipped');
    }

    // 새 카드를 추가하는 함수
    function addCard(name = '', description = '') {
        const cardContainer = document.getElementById('cardContainer');

        const cardDiv = document.createElement('div');
        cardDiv.className = 'card';

        // 카드 클릭 시 플립
        cardDiv.addEventListener('click', function(event) {
            if (event.target.tagName !== 'INPUT') {
                flipCard(this);
            }
        });

        const nameCardDiv = document.createElement('div');
        nameCardDiv.className = 'name_card';

        const frontDiv = document.createElement('div');
        frontDiv.className = 'front';

        const nameTextFrontDiv = document.createElement('div');
        nameTextFrontDiv.className = 'name-text-front';
        nameTextFrontDiv.textContent = name;

        const backDiv = document.createElement('div');
        backDiv.className = 'back';

        const editButton = document.createElement('img');
        editButton.src = '/static/image/EditButton.png';
        editButton.alt = 'Edit Button';
        editButton.className = 'edit-button';

        // 편집 버튼 클릭 시 입력 필드 토글
        editButton.addEventListener('click', function(event) {
            event.stopPropagation();
            toggleEditInput(this);
        });

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.className = 'edit-input name-input';
        nameInput.placeholder = '이름을 입력해주세요';
        nameInput.value = name;

        const descriptionInput = document.createElement('input');
        descriptionInput.type = 'text';
        descriptionInput.className = 'edit-input description-input';
        descriptionInput.placeholder = '설명을 입력해주세요';
        descriptionInput.value = description;

        // 입력 필드의 값이 변경되면 카드의 앞면의 이름도 업데이트
        nameInput.addEventListener('input', function() {
            nameTextFrontDiv.textContent = this.value;
        });

        // 엔터 키를 눌러 입력 내용을 저장
        nameInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                saveText(this);
            }
        });

        descriptionInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                saveText(this);
            }
        });

        const nameTextDiv = document.createElement('div');
        nameTextDiv.className = 'saved-text name-text';
        nameTextDiv.textContent = name;
        if (name) nameTextDiv.style.display = 'block';

        const descriptionTextDiv = document.createElement('div');
        descriptionTextDiv.className = 'saved-text description-text';
        descriptionTextDiv.textContent = description;
        if (description) descriptionTextDiv.style.display = 'block';

        backDiv.appendChild(editButton);
        backDiv.appendChild(nameInput);
        backDiv.appendChild(descriptionInput);
        backDiv.appendChild(nameTextDiv);
        backDiv.appendChild(descriptionTextDiv);

        frontDiv.appendChild(nameTextFrontDiv);

        nameCardDiv.appendChild(frontDiv);
        nameCardDiv.appendChild(backDiv);

        cardDiv.appendChild(nameCardDiv);

        // Add Person 버튼 앞에 카드 삽입
        cardContainer.insertBefore(cardDiv, document.getElementById('add-person'));
    }

    // 입력 필드와 텍스트를 토글하는 함수
    function toggleEditInput(button) {
        const backDiv = button.parentElement;
        const nameInput = backDiv.querySelector('.name-input');
        const descriptionInput = backDiv.querySelector('.description-input');
        const nameText = backDiv.querySelector('.name-text');
        const descriptionText = backDiv.querySelector('.description-text');

        // 입력 필드에 기존 값을 설정
        nameInput.value = nameText.textContent;
        descriptionInput.value = descriptionText.textContent;

        // 입력 필드를 토글
        if (nameInput.style.display === 'block' || descriptionInput.style.display === 'block') {
            nameInput.style.display = 'none';
            descriptionInput.style.display = 'none';
        } else {
            nameInput.style.display = 'block';
            descriptionInput.style.display = 'block';
            nameInput.focus();
        }

        nameText.style.display = 'block';
        descriptionText.style.display = 'block';
    }

    // 입력 내용을 저장하는 함수
    function saveText(input) {
        const backDiv = input.parentElement;
        const nameInput = backDiv.querySelector('.name-input');
        const descriptionInput = backDiv.querySelector('.description-input');
        const nameTextDiv = backDiv.querySelector('.name-text');
        const descriptionTextDiv = backDiv.querySelector('.description-text');

        if (input === nameInput) {
            nameTextDiv.textContent = nameInput.value;
            nameTextDiv.style.display = 'block';
            nameInput.style.display = 'none';
            // Update front name
            const frontDiv = backDiv.parentElement.querySelector('.front .name-text-front');
            frontDiv.textContent = nameInput.value;
        } else if (input === descriptionInput) {
            descriptionTextDiv.textContent = descriptionInput.value;
            descriptionTextDiv.style.display = 'block';
            descriptionInput.style.display = 'none';
        }
        saveCards();
    }

    // 모든 카드를 로컬 스토리지에 저장하는 함수
    function saveCards() {
        const cardContainer = document.getElementById('cardContainer');
        const cards = [];
        cardContainer.querySelectorAll('.card').forEach(cardDiv => {
            const nameText = cardDiv.querySelector('.name-text').textContent;
            const descriptionText = cardDiv.querySelector('.description-text').textContent;
            cards.push({ name: nameText, description: descriptionText });
        });
        localStorage.setItem('cards', JSON.stringify(cards));
    }

    // 로컬 스토리지에서 카드를 불러와 추가하는 함수
    function loadCards() {
        const cards = JSON.parse(localStorage.getItem('cards') || '[]');
        cards.forEach(card => addCard(card.name, card.description));
    }

    // 정보 텍스트를 토글하는 함수
    function toggleInfoText() {
        const infoText = document.getElementById('info_text');
        if (infoText.style.display === 'none' || infoText.style.display === '') {
            infoText.style.display = 'block';
        } else {
            infoText.style.display = 'none';
        }
    }
</script>
</body>
</html>
